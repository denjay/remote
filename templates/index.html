<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="shortcut icon" href="/favicon.ico">
</head>

<body>
  <span>匹配码</span>

  <input type="text">
  <br>
  <button onclick="send_code('exec', {description: '关机', code: 'poweroff'})">关机</button>
  <br>
  <button onclick="send_code('exec', {description: '息屏', code: 'xset dpms force off'})">息屏</button>
  <br>
  <button onclick="send_code('exec', {description: '打开网易云音乐', code:'netease-cloud-music'})">网易云音乐</button>
  <br>
  <button onclick="send_code('order', {description: '播放/暂停'})">播放/暂停</button>
  <br>
  <button onclick="send_code('order', {description: '上一曲'})">上一曲</button>
  <br>
  <button onclick="send_code('order', {description: '下一曲'})">下一曲</button>
  <br>
  <button onclick="send_code('order', {description: '音量加'})">音量加</button>
  <br>
  <button onclick="send_code('order', {description: '音量减'})">音量减</button>
  <br>
  <button onclick="send_code('get_clipboard_content')">获取剪贴板内容</button>
  <br>
  <textarea cols="30" rows="5">输入要传的文字</textarea>
  <button onclick="set_clipboard_content()">传文字到剪贴板</button>
  <br>
  <p></p>

  <script>
    function set_clipboard_content() {
      let content = document.getElementsByTagName("textarea")[0].value
      send_code('set_clipboard_content', {
        content
      })
    }
    // 获取主机名
    var hostname
    window.location.search.substr(1).split("&").forEach((item, index, arr) => {
      if (item.split("=")[0] == "hostname") {
        hostname = item.split("=")[1]
        document.getElementsByTagName("input")[0].value = hostname
      }
    })
    // 缓存当前ip
    var ip = window.location.host.split(":")[0]
    window.localStorage.setItem("ip", ip)

    // 获取本机ip地址
    function getIP(onNewIP) { //  onNewIp - your listener function for new IPs
      var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection; //compatibility for firefox and chrome
      var pc = new myPeerConnection({
          iceServers: []
        }), // 空的ICE服务器（STUN或者TURN）
        noop = function () {},
        localIPs = {}, //记录有没有被调用到onNewIP这个listener上
        ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g,
        key;

      function ipIterate(ip) {
        if (!localIPs[ip]) onNewIP(ip);
        localIPs[ip] = true;
      }
      pc.createDataChannel(""); //create a bogus data channel
      pc.createOffer().then(function (sdp) {
        sdp.sdp.split('\n').forEach(function (line) {
          if (line.indexOf('candidate') < 0) return;
          line.match(ipRegex).forEach(ipIterate);
        });
        pc.setLocalDescription(sdp, noop, noop);
      }); // create offer and set local description
      pc.onicecandidate = function (ice) { //listen for candidate events
        if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex))
          return;
        ice.candidate.candidate.match(ipRegex).forEach(ipIterate);
      };
    }

    var ul_el = document.getElementsByTagName("ul")[0]
    // 群发请求
    function mass(path, nsid, params) {
      var pormises = [];
      for (var i = 1; i < 255; i++) {
        let p = new Promise((resolve, reject) => {
          let ip = nsid + i;
          let ajax = new XMLHttpRequest();
          ajax.open('post', `http://${ip}:8765/${path}`);
          ajax.setRequestHeader('content-type', 'application/json');
          ajax.send(params);
          ajax.onreadystatechange = function () {
            if (ajax.readyState == 4 && ajax.status == 200) {
              window.localStorage.setItem("ip", ajax.responseURL.match(/\/\/(.*?):/)[1]); // 更新缓存的ip
              resolve(JSON.parse(ajax.responseText));
            }
          }
        });
        pormises.push(p)
      };
      let p = new Promise((resolve, reject) => {
        setTimeout(() => {
          reject("超时，请重试！")
        }, 10000)
      });
      pormises.push(p);
      Promise.race(pormises).then((result) => {
        if (result.file_url) {
          window.location.href = result.file_url;
        } else if (result.text) {
          var p_el = document.getElementsByTagName("p")[0]
          p_el.innerHTML = result.text
        } else if (result.message != undefined) {
          alert(result.message)
        }
      }).catch((error) => {
        alert(error)
      })
    }

    // 发送请求
    function send_code(path, params) {
      var hostname = document.getElementsByTagName("input")[0].value
      if (params) {
        params["hostname"] = hostname
      } else {
        params = {
          "hostname": hostname
        }
      }
      params = JSON.stringify(params)
      let ip = window.localStorage.getItem("ip")
      ip = ip ? ip : "0.0.0.0";
      var pormises = [];
      let p = new Promise((resolve, reject) => {
        let ajax = new XMLHttpRequest();
        ajax.open('post', `http://${ip}:8765/${path}`);
        ajax.setRequestHeader('content-type', 'application/json');
        ajax.send(params);
        ajax.onreadystatechange = function () {
          if (ajax.readyState == 4 && ajax.status == 200) {
            resolve(JSON.parse(ajax.responseText));
          }
        }
      });
      pormises.push(p)
      p = new Promise((resolve, reject) => {
        setTimeout(() => {
          reject("超时，请重试！")
        }, 2000)
      });
      pormises.push(p);
      Promise.race(pormises).then((result) => {
        if (result.file_url) {
          window.location.href = result.file_url;
        } else if (result.text) {
          var p_el = document.getElementsByTagName("p")[0]
          p_el.innerHTML = result.text
        } else if (result.message != undefined) {
          alert(result.message)
        }
      }).catch((error) => {
        // 如果知道本机IP，就向所在局域网发送请求
        getIP(function (local_ip) {
          var nsid = local_ip.split(".").slice(0, 3).join(".") + "."; // 网络号
          mass(path, nsid, params);
        });
        // 向localstorage中的网络号发送请求
        if (window.localStorage.getItem("ip")) {
          var nsid = window.localStorage.getItem("ip").split(".").slice(0, 3).join(".") + ".";
          mass(path, nsid, params);
        }
      })
    }
  </script>
</body>

</html>