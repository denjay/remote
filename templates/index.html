<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="shortcut icon" href="/favicon.ico">
</head>

<body>
  <span>匹配码</span>

  <input type="text">
  <br>
  <button onclick="send_code('exec', '关机', 'poweroff')">关机</button>
  <br>
  <button onclick="send_code('exec', '息屏', 'xset dpms force off')">息屏</button>
  <br>
  <button onclick="send_code('exec', '打开网易云音乐', 'netease-cloud-music')">网易云音乐</button>
  <br>
  <button onclick="send_code('order', '播放/暂停')">播放/暂停</button>
  <br>
  <button onclick="send_code('order', '上一曲')">上一曲</button>
  <br>
  <button onclick="send_code('order', '下一曲')">下一曲</button>
  <br>
  <button onclick="send_code('order', '音量加')">音量加</button>
  <br>
  <button onclick="send_code('order', '音量减')">音量减</button>
  <br>
  <ul></ul>

  <script>
    // 获取主机名
    var hostname
    window.location.search.substr(1).split("&").forEach((item, index, arr) => {
      if (item.split("=")[0] == "hostname") {
        hostname = item.split("=")[1]
        document.getElementsByTagName("input")[0].value = hostname
      }
    })
    // 缓存当前ip
    var ip = window.location.host.split(":")[0]
    window.localStorage.setItem("ip", ip)

    // 获取本机ip地址
    function getIPs(callback) {
      var ip_dups = {};
      var useWebKit = !!window.webkitRTCPeerConnection;
      //minimal requirements for data connection
      var mediaConstraints = {
        optional: [{
          RtpDataChannels: true
        }]
      };
      var servers = {
        iceServers: [{
          urls: "stun:stun.services.mozilla.com"
        }]
      };
      //construct a new RTCPeerConnection
      var pc = new RTCPeerConnection(servers, mediaConstraints);

      function handleCandidate(candidate) {
        //match just the IP address
        var ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/
        var ip_addr = ip_regex.exec(candidate)[1];
        //remove duplicates
        if (ip_dups[ip_addr] === undefined)
          callback(ip_addr);
        ip_dups[ip_addr] = true;
      }
      //listen for candidate events
      pc.onicecandidate = function (ice) {
        //skip non-candidate events
        if (ice.candidate)
          handleCandidate(ice.candidate.candidate);
      };
      //create a bogus data channel
      pc.createDataChannel("");
      //create an offer sdp
      pc.createOffer(function (result) {
        //trigger the stun server request
        pc.setLocalDescription(result, function () {}, function () {});
      }, function () {});
      //wait for a while to let everything done
      setTimeout(function () {
        //read candidate info from local description
        var lines = pc.localDescription.sdp.split('\n');
        lines.forEach(function (line) {
          if (line.indexOf('a=candidate:') === 0)
            handleCandidate(line);
        });
      }, 1000);
    }

    // 发送请求
    function send_code(type, description, code) {
      var ul_el = document.getElementsByTagName("ul")[0]
      var hostname = document.getElementsByTagName("input")[0].value
      if (type == 'exec') {
        var params = {
          hostname: hostname,
          code: code,
          description: description
        };
      } else if (type == 'order') {
        var params = {
          hostname: hostname,
          description: description
        };
      }
      params = JSON.stringify(params)
      let ip = window.localStorage.getItem("ip")
      ip = ip ? ip : "0.0.0.0";
      var pormises = [];
      let p = new Promise((resolve, reject) => {
        let ajax = new XMLHttpRequest();
        ajax.open('post', `http://${ip}:8765/${type}`);
        ajax.setRequestHeader('content-type', 'application/json');
        ajax.send(params);
        ajax.onreadystatechange = function () {
          if (ajax.readyState == 4 && ajax.status == 200) {
            resolve("执行成功");
          }
        }
      });
      pormises.push(p)
      p = new Promise((resolve, reject) => {
        setTimeout(() => {
          reject("超时，请重试！")
        }, 2000)
      });
      pormises.push(p);
      Promise.race(pormises).then((result) => {
        var li_el = document.createElement("li")
        li_el.innerHTML = result
        ul_el.appendChild(li_el);
      }).catch((error) => {
        getIPs(function (local_ip) {
          var nsid = local_ip.split(".").slice(0, 3).join(".") + ".";
          var pormises = [];
          for (var i = 1; i < 255; i++) {
            let p = new Promise((resolve, reject) => {
              let ip = nsid + i;
              let ajax = new XMLHttpRequest();
              ajax.open('post', `http://${ip}:8765/${type}`);
              ajax.setRequestHeader('content-type', 'application/json');
              ajax.send(params);
              ajax.onreadystatechange = function () {
                if (ajax.readyState == 4 && ajax.status == 200) {
                  window.localStorage.setItem("ip", ajax.responseURL.match(/\/\/(.*?):/)[1]);  // 更新缓存的ip
                  resolve("执行成功");
                }
              }
            });
            pormises.push(p)
          };
          let p = new Promise((resolve, reject) => {
            setTimeout(() => {
              reject("超时，请重试！")
            }, 10000)
          });
          pormises.push(p);
          Promise.race(pormises).then((result) => {
            var li_el = document.createElement("li")
            li_el.innerHTML = result
            ul_el.appendChild(li_el);
          }).catch((error) => {
            var li_el = document.createElement("li")
            li_el.innerHTML = error;
            ul_el.appendChild(li_el);
          })
        });
      })
    }
  </script>
</body>

</html>